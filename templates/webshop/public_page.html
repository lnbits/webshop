{% extends "public.html" %}
{% block title %}{{ public_page_name }}{% endblock %}
{% block footer %}{% endblock %}
{% block page_container %}
{% set primary_color = shop.get('primary_color', '#1c56ac') %}
{% set secondary_color = shop.get('secondary_color', '#0bb6d5') %}
<q-page-container>
  <q-page class="bg-grey-1">
    <div class="q-pa-md q-pa-xl-lg">
      <div class="shop-hero q-pa-lg q-mb-lg">
        <div class="row items-center q-col-gutter-md">
          <div class="col">
            <div class="shop-pill">iframe ready</div>
            <div class="text-h4 text-weight-bold q-mt-xs" v-text="shop.name"></div>
            <div class="text-subtitle1 text-grey-8" v-text="shop.description"></div>
            <div class="row q-col-gutter-sm q-mt-md">
              <div class="col-auto">
                <div class="color-chip">
                  <span class="chip-swatch" :style="{background: shop.primary_color}"></span>
                  <span class="text-caption">Primary · ${ shop.primary_color }</span>
                </div>
              </div>
              <div class="col-auto">
                <div class="color-chip">
                  <span class="chip-swatch" :style="{background: shop.secondary_color}"></span>
                  <span class="text-caption">Secondary · ${ shop.secondary_color }</span>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-auto">
            <div class="embed-card q-pa-md">
              <div class="text-caption text-grey-8 q-mb-sm">Embed this shop</div>
              <div class="row items-center no-wrap q-col-gutter-sm">
                <div class="col">
                  <q-input
                    dense
                    standout="bg-white text-dark"
                    readonly
                    v-model="iframeCode"
                    class="embed-input"
                  ></q-input>
                </div>
                <div class="col-auto">
                  <q-btn
                    dense
                    color="secondary"
                    unelevated
                    icon="content_copy"
                    @click="copyEmbed"
                  >
                    Copy
                  </q-btn>
                </div>
              </div>
              <div class="text-caption text-grey-7 q-mt-xs">
                Paste the snippet anywhere to drop this shop in via iframe.
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row q-col-gutter-lg">
        <div class="col-12 col-lg-8">
          <div class="row items-center q-mb-md">
            <div class="col">
              <div class="text-subtitle1 text-weight-bold">Products</div>
              <div class="text-caption text-grey-7">
                Pulled directly from your Inventory items.
              </div>
            </div>
            <div class="col-12 col-md-5 col-lg-4">
              <q-input
                dense
                filled
                debounce="150"
                v-model="search"
                placeholder="Search products..."
                class="bg-white"
              >
                <template v-slot:prepend>
                  <q-icon name="search"></q-icon>
                </template>
              </q-input>
            </div>
          </div>

          <q-banner
            v-if="error"
            class="q-mb-md"
            rounded
            dense
            style="background: #fff6f6; color: #8a1c1c"
          >
            <template v-slot:avatar>
              <q-icon name="error_outline" color="red"></q-icon>
            </template>
            ${ error }
          </q-banner>

          <div v-if="loading" class="row q-col-gutter-md">
            <div v-for="n in 6" :key="n" class="col-12 col-sm-6 col-md-4">
              <q-skeleton type="rect" height="280px" class="rounded-borders"></q-skeleton>
            </div>
          </div>

          <div v-else class="row q-col-gutter-md">
            <div
              v-if="!filteredProducts.length"
              class="col-12"
            >
              <q-card flat class="q-pa-lg bg-white text-grey-7 text-center">
                <q-icon name="inventory_2" size="lg" class="q-mb-sm" color="grey-6"></q-icon>
                <div class="text-body1 text-weight-medium">No products to show yet</div>
                <div class="text-caption">Link an inventory and keep items active to display them here.</div>
              </q-card>
            </div>

            <div
              v-for="item in filteredProducts"
              :key="item.id"
              class="col-12 col-sm-6 col-md-4"
            >
              <q-card class="product-card column no-wrap">
                <div
                  class="product-thumb"
                  :style="productImage(item) ? { backgroundImage: `linear-gradient(135deg, rgba(0,0,0,.15), rgba(0,0,0,.15)), url(${productImage(item)})` } : {}"
                >
                  <div class="product-badge" v-if="item.discount_percentage">
                    -${ item.discount_percentage }%
                  </div>
                </div>
                <q-card-section class="col">
                  <div class="text-subtitle1 text-weight-bold ellipsis-2-lines" v-text="item.name"></div>
                  <div class="text-caption text-grey-7 ellipsis-3-lines q-mt-xs" v-text="item.description || 'No description provided.'"></div>
                </q-card-section>
                <q-separator></q-separator>
                <q-card-actions align="between" class="q-pa-md items-center">
                  <div class="column">
                    <div class="text-body1 text-weight-bold" v-text="priceLabel(item)"></div>
                    <div class="text-caption text-grey-6">
                      <q-icon name="inventory" size="16px" class="q-mr-xs"></q-icon>
                      ${ item.quantity_in_stock ?? '∞' } in stock
                    </div>
                  </div>
                  <q-btn
                    color="primary"
                    no-caps
                    unelevated
                    @click="addToCart(item)"
                  >
                    Add
                  </q-btn>
                </q-card-actions>
              </q-card>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-4">
          <q-card class="cart-card">
            <q-card-section class="row items-center justify-between">
              <div>
                <div class="text-subtitle1 text-weight-bold">Cart</div>
                <div class="text-caption text-grey-7">Checkout coming soon.</div>
              </div>
              <q-badge
                color="secondary"
                class="text-weight-bold"
                :label="cartCount + ' item' + (cartCount === 1 ? '' : 's')"
              ></q-badge>
            </q-card-section>
            <q-separator></q-separator>

            <q-card-section v-if="!cart.length" class="text-grey-6 text-center">
              <q-icon name="shopping_bag" size="32px" class="q-mb-sm" color="grey-5"></q-icon>
              <div class="text-body2">Cart is empty</div>
              <div class="text-caption">Add a product to get started.</div>
            </q-card-section>

            <q-list v-else class="cart-list">
              <q-item v-for="item in cart" :key="item.id" class="cart-item">
                <q-item-section>
                  <div class="text-body2 text-weight-bold ellipsis" v-text="item.name"></div>
                  <div class="text-caption text-grey-6" v-text="priceLabel(item)"></div>
                  <div class="row items-center q-gutter-xs q-mt-xs">
                    <q-btn
                      round
                      dense
                      flat
                      color="primary"
                      icon="remove"
                      @click="updateQuantity(item.id, -1)"
                    ></q-btn>
                    <div class="text-body2 text-weight-bold q-mx-sm">${ item.quantity }</div>
                    <q-btn
                      round
                      dense
                      flat
                      color="primary"
                      icon="add"
                      @click="updateQuantity(item.id, 1)"
                    ></q-btn>
                    <q-space></q-space>
                    <q-btn
                      dense
                      flat
                      color="grey-7"
                      icon="delete"
                      @click="removeFromCart(item.id)"
                    ></q-btn>
                  </div>
                </q-item-section>
                <q-item-section side top>
                  <div class="text-body2 text-weight-bold" v-text="lineTotal(item)"></div>
                </q-item-section>
              </q-item>
            </q-list>

            <q-separator v-if="cart.length"></q-separator>
            <q-card-section v-if="cart.length">
              <div class="row items-center justify-between q-mb-sm">
                <div class="text-body1 text-weight-medium">Subtotal</div>
                <div class="text-h6 text-weight-bold" v-text="cartTotalLabel"></div>
              </div>
              <q-btn
                unelevated
                color="primary"
                class="full-width"
                no-caps
                disable
              >
                Checkout coming soon
              </q-btn>
            </q-card-section>
          </q-card>
        </div>
      </div>
    </div>
  </q-page>
</q-page-container>
{% endblock %}

{% block styles %}
<style>
  :root {
    --shop-primary: {{ primary_color }};
    --shop-secondary: {{ secondary_color }};
  }
  .q-page-container {
    background: linear-gradient(180deg, #f8fafc 0%, #edf2f7 40%, #f7fafc 100%);
  }
  .shop-hero {
    border-radius: 20px;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.35), rgba(0, 0, 0, 0.15)), linear-gradient(120deg, var(--shop-primary), var(--shop-secondary));
    color: #fff;
    box-shadow: 0 25px 60px rgba(0, 0, 0, 0.15);
  }
  .shop-pill {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.15);
    font-size: 12px;
    letter-spacing: 0.03em;
    text-transform: uppercase;
  }
  .color-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background: rgba(255, 255, 255, 0.14);
    border-radius: 10px;
  }
  .chip-swatch {
    width: 18px;
    height: 18px;
    display: inline-block;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.6);
  }
  .embed-card {
    background: rgba(255, 255, 255, 0.14);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 14px;
    color: #fff;
    min-width: 320px;
  }
  .embed-input .q-field__control {
    background: rgba(255, 255, 255, 0.9);
    color: #111;
  }
  .product-card {
    border-radius: 14px;
    overflow: hidden;
    background: #fff;
    box-shadow: 0 14px 32px rgba(0, 0, 0, 0.08);
    min-height: 320px;
  }
  .product-thumb {
    height: 140px;
    background: linear-gradient(120deg, rgba(0, 0, 0, 0.04), rgba(0, 0, 0, 0.06));
    background-size: cover;
    background-position: center;
    position: relative;
  }
  .product-badge {
    position: absolute;
    top: 12px;
    left: 12px;
    background: var(--shop-secondary);
    color: #000;
    padding: 6px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 700;
  }
  .cart-card {
    border-radius: 18px;
    overflow: hidden;
    background: #fff;
    box-shadow: 0 18px 38px rgba(0, 0, 0, 0.1);
  }
  .cart-item + .cart-item {
    border-top: 1px solid #f0f2f5;
  }
  .ellipsis-2-lines {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .ellipsis-3-lines {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .q-header,
  .q-footer {
    display: none;
  }
  .bg-primary,
  .q-btn.bg-primary {
    background: var(--shop-primary) !important;
    color: #fff !important;
  }
  .bg-secondary,
  .q-btn.bg-secondary,
  .q-badge.bg-secondary {
    background: var(--shop-secondary) !important;
    color: #111 !important;
  }
  .text-primary {
    color: var(--shop-primary) !important;
  }
  .text-secondary {
    color: var(--shop-secondary) !important;
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  const SHOP_DATA = {{ shop | tojson | safe if shop else '{}' }};
  const SHOP_ID = '{{ shop_id }}';

  window.app = Vue.createApp({
    mixins: [windowMixin],
    delimiters: ['${', '}'],
    data() {
      return {
        shop: SHOP_DATA || {},
        inventoryId:
          (SHOP_DATA && SHOP_DATA.inventory_id) ||
          new URLSearchParams(window.location.search).get('inventory_id') ||
          '',
        products: [],
        loading: false,
        error: '',
        search: '',
        cart: []
      }
    },
    computed: {
      filteredProducts() {
        const term = this.search.trim().toLowerCase()
        if (!term) return this.products
        return this.products.filter(
          item =>
            (item.name && item.name.toLowerCase().includes(term)) ||
            (item.description && item.description.toLowerCase().includes(term))
        )
      },
      cartCount() {
        return this.cart.reduce((sum, item) => sum + item.quantity, 0)
      },
      cartTotal() {
        return this.cart.reduce(
          (sum, item) => sum + Number(item.price || 0) * item.quantity,
          0
        )
      },
      cartTotalLabel() {
        return `${this.formatAmount(this.cartTotal)} ${this.currencyLabel}`
      },
      currencyLabel() {
        return this.shop.currency || 'sat'
      },
      iframeCode() {
        return `<iframe src="${window.location.origin}/webshop/${SHOP_ID}" width="100%" height="900" style="border:0; border-radius: 12px;"></iframe>`
      }
    },
    methods: {
      async fetchProducts() {
        if (!this.inventoryId) {
          this.error = 'No inventory linked to this shop yet.'
          return
        }
        this.loading = true
        this.error = ''
        try {
          const params = new URLSearchParams({
            limit: 100,
            offset: 0,
            sortby: 'created_at',
            direction: 'desc',
            is_active: true
          })
          const response = await fetch(
            `/inventory/api/v1/items/${this.inventoryId}/paginated?${params.toString()}`
          )
          if (!response.ok) throw new Error('Unable to load products.')
          const payload = await response.json()
          this.products = Array.isArray(payload.data)
            ? payload.data.filter(Boolean)
            : []
        } catch (err) {
          console.error(err)
          this.error = 'Could not load products from inventory.'
        } finally {
          this.loading = false
        }
      },
      addToCart(item) {
        const existing = this.cart.find(i => i.id === item.id)
        const limit =
          typeof item.quantity_in_stock === 'number'
            ? Math.max(item.quantity_in_stock, 0)
            : Infinity
        if (existing) {
          if (existing.quantity >= limit) return
          existing.quantity += 1
          return
        }
        this.cart.push({
          id: item.id,
          name: item.name,
          price: item.price,
          quantity: limit === Infinity ? 1 : Math.min(1, limit),
          quantity_in_stock: item.quantity_in_stock
        })
      },
      updateQuantity(id, delta) {
        const entry = this.cart.find(i => i.id === id)
        if (!entry) return
        const limit =
          typeof entry.quantity_in_stock === 'number'
            ? Math.max(entry.quantity_in_stock, 0)
            : Infinity
        entry.quantity = Math.min(Math.max(entry.quantity + delta, 0), limit || 0)
        if (entry.quantity <= 0) {
          this.cart = this.cart.filter(i => i.id !== id)
        }
      },
      removeFromCart(id) {
        this.cart = this.cart.filter(item => item.id !== id)
      },
      productImage(item) {
        if (!item.images) return ''
        const raw = String(item.images).trim()
        if (!raw) return ''
        try {
          const parsed = JSON.parse(raw)
          if (Array.isArray(parsed) && parsed[0]) return parsed[0]
        } catch (err) {
          /* ignore */
        }
        if (raw.includes(',')) return raw.split(',')[0].trim()
        return raw
      },
      priceLabel(item) {
        return `${this.formatAmount(item.price)} ${this.currencyLabel}`
      },
      lineTotal(item) {
        return `${this.formatAmount(item.price * item.quantity)} ${this.currencyLabel}`
      },
      formatAmount(amount) {
        const numeric = Number(amount) || 0
        return new Intl.NumberFormat(undefined, {
          minimumFractionDigits: 0,
          maximumFractionDigits: 2
        }).format(numeric)
      },
      async copyEmbed() {
        try {
          await navigator.clipboard.writeText(this.iframeCode)
          this.$q.notify({
            type: 'positive',
            message: 'Iframe code copied'
          })
        } catch (err) {
          console.warn(err)
          this.$q.notify({
            type: 'warning',
            message: 'Unable to copy automatically'
          })
        }
      }
    },
    mounted() {
      this.fetchProducts()
    }
  }).mount('#vue')
</script>
{% endblock %}
